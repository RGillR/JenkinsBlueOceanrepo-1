pipeline {
   agent any
   environment {
       DEMO='3.1'
       RELEASE='demo3 2.1'
   }
   stages {

        stage('TEST') {
            steps{ 
                echo "I am in "
			    echo "JOB_NAME = $JOB_NAME"
                script{
                    if (Math.random() > 0.5) {
                        throw new Exception()
                    }
                }
                writeFile file: 'test_results.txt', text: 'passed'
            }
        }
        stage('build') {
            environment{
                LOG_LEVEL = 'log level for build stage'
            }
            parallel {
                stage  ('build-stage 1') {
                    steps {
                            echo "stage name = $STAGE_NAME and log level = $LOG_LEVEL"
                            sh 'chmod +x build.sh'
                            withCredentials ([string(credentialsId: 'an-api-key', variable: 'API_KEY')]) {
                                   sh '''
                                       ./build.sh
                                       ''' 
                            }
                    }
                }
                
            } 
        }
     stage('Deploy'){
            steps {
                     echo 'this is the deploy stage '
                    }           
        }
        }
    post {
        success {
            echo ' This is a successfull build'
            archiveArtifacts 'test_results.txt'
            slackSend channel: '#jenkins-declarative-pipeline',
                      message: "Release ${env.RELEASE}, success: ${currentBuild.fullDisplayName}."      
        }
        failure{
            slackSend channel: '#jenkins-declarative-pipeline',
                      message: "Release ${env.RELEASE}, failed: ${currentBuild.fullDisplayName}."   
        }
    }
}    
   
